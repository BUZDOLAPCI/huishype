# Ghost Nodes vs Active Nodes Zoom Test
# Tests that ghost nodes (small, gray) and active nodes (colored, larger)
# become visible at high zoom levels (Z15+).
#
# Uses the +/- zoom buttons added to the map UI (since MapLibre RN doesn't
# respond to double-tap zoom from Maestro). Screenshots allow visual verification
# of node appearance at different zoom levels.
#
# Prerequisites:
# - App installed on emulator, Metro dev server running
# - Backend API accessible with seeded data
#
# Usage:
# maestro test apps/app/e2e/mobile/ghost-nodes-zoom.yaml

appId: nl.huishype.app
tags:
  - feature:map
  - feature:ghost-nodes
---
# Launch the app
- launchApp

# Handle Expo Dev Client server picker if shown
- tapOn:
    text: ".*10.0.2.2:8081.*"
    optional: true

# Wait for app to fully load
- extendedWaitUntil:
    visible: "HuisHype"
    timeout: 60000

# Dismiss Expo developer menu if it appears
- tapOn:
    text: "Ã—"
    optional: true
- tapOn:
    point: "50%,30%"
    optional: true
- waitForAnimationToEnd

# Wait for map to render (zoom indicator confirms map is ready)
- extendedWaitUntil:
    visible: "Zoom.*"
    timeout: 20000

# Take initial screenshot at default zoom (Z13)
# Shows clusters at low zoom
- takeScreenshot: maestro-screenshots/ghost_nodes_01_default_zoom

# Use the zoom-in button to increase zoom level
# Default zoom is 13, we need to get to 15+ for ghost nodes
# First zoom: Z13 -> Z14
- tapOn:
    text: "+"
- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/ghost_nodes_02_zoom_14

# Second zoom: Z14 -> Z15 (ghost node threshold)
- tapOn:
    text: "+"
- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/ghost_nodes_03_zoom_15

# Third zoom: Z15 -> Z16
- tapOn:
    text: "+"
- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/ghost_nodes_04_zoom_16

# Fourth zoom: Z16 -> Z17 (individual points visible)
- tapOn:
    text: "+"
- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/ghost_nodes_05_zoom_17

# Fifth zoom: Z17 -> Z18
- tapOn:
    text: "+"
- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/ghost_nodes_06_zoom_18

# Sixth zoom: Z18 -> Z19
# At this zoom, ghost nodes should be clearly visible (gray, smaller)
# and active nodes should be prominent (colored, larger)
- tapOn:
    text: "+"
- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/ghost_nodes_07_zoom_19

# Seventh zoom: Z19 -> Z20 (max zoom)
- tapOn:
    text: "+"
- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/ghost_nodes_08_max_zoom

# Verify zoom indicator shows high zoom level (should be ~20)
- assertVisible:
    text: "Zoom.*"

# Take screenshot showing max zoom level
- takeScreenshot: maestro-screenshots/ghost_nodes_09_final_zoom_level

# Test tap on a visible node at high zoom
# At Z17+, individual properties should be tappable
- tapOn:
    point: "50%,50%"
- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/ghost_nodes_10_tap_at_high_zoom

# Check if preview card appeared (indicates we tapped a property)
- assertVisible:
    text: "Like"
    optional: true

# Check for Comment button too
- assertVisible:
    text: "Comment"
    optional: true

# Dismiss any UI by swiping down
- swipe:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd

# Verify map is still functional
- extendedWaitUntil:
    visible: "Zoom.*"
    timeout: 10000

- takeScreenshot: maestro-screenshots/ghost_nodes_11_final_state

# Test zoom out works
- tapOn:
    text: "-"
- waitForAnimationToEnd

# Verify zoom indicator shows lower zoom
- assertVisible:
    text: "Zoom.*"

- takeScreenshot: maestro-screenshots/ghost_nodes_12_zoomed_out

# Verify tab navigation still works
- assertVisible: "Map"
- assertVisible: "Feed"
