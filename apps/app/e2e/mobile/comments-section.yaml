# Comments Section E2E Test
# Tests the comments functionality within the property bottom sheet.
# Navigates to a property, expands bottom sheet, and verifies comments section.
#
# Prerequisites:
# - App installed on emulator, Metro dev server running
# - Backend API accessible with seeded data
#
# Usage:
# maestro test apps/app/e2e/mobile/comments-section.yaml

appId: nl.huishype.app
tags:
  - feature:comments
  - feature:bottom-sheet
---
# Launch the app
- launchApp

# Handle Expo Dev Client server picker if shown
- tapOn:
    text: ".*10.0.2.2:8081.*"
    optional: true

# Wait for app to fully load
- extendedWaitUntil:
    visible: "HuisHype"
    timeout: 60000

# Dismiss Expo developer menu if it appears
- tapOn:
    text: "Ã—"
    optional: true
- tapOn:
    point: "50%,30%"
    optional: true
- waitForAnimationToEnd

# Wait for map to render
- extendedWaitUntil:
    visible: "Zoom.*"
    timeout: 20000

- takeScreenshot: maestro-screenshots/comments_01_map_loaded

# First, zoom in to z17 where individual property markers are visible
# At z13 (default), only clusters show - we need z15+ for individual markers
- tapOn:
    text: "+"
- waitForAnimationToEnd
- tapOn:
    text: "+"
- waitForAnimationToEnd
- tapOn:
    text: "+"
- waitForAnimationToEnd
- tapOn:
    text: "+"
- waitForAnimationToEnd

# Now at z17, individual markers should be visible at Eindhoven center
# DON'T pan - stay where the properties are
- takeScreenshot: maestro-screenshots/comments_02_zoomed_to_z17

# Zoom in one more level for denser markers
- tapOn:
    text: "+"
- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/comments_03_zoomed_to_z18

# Try to select a property by tapping on the map
# At z18 with Eindhoven center, there should be property markers
- tapOn:
    point: "50%,50%"
- waitForAnimationToEnd

# Try tapping multiple locations to find a property marker
- tapOn:
    point: "30%,40%"
    optional: true
- waitForAnimationToEnd

- tapOn:
    point: "70%,60%"
    optional: true
- waitForAnimationToEnd

- tapOn:
    point: "40%,30%"
    optional: true
- waitForAnimationToEnd

- tapOn:
    point: "60%,70%"
    optional: true
- waitForAnimationToEnd

- takeScreenshot: maestro-screenshots/comments_04_after_taps

# Look for preview card elements indicating a property was selected
- assertVisible:
    text: "Like"
    optional: true

# If preview card is visible, expand the bottom sheet fully
# First do a partial expansion
- swipe:
    start: "50%,90%"
    end: "50%,50%"
    duration: 500

- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/comments_05_partial_expand

# Now fully expand
- swipe:
    start: "50%,50%"
    end: "50%,15%"
    duration: 500

- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/comments_06_full_expand

# Look for the Comments section header
- assertVisible:
    text: "Comments"
    optional: true

- takeScreenshot: maestro-screenshots/comments_07_comments_header

# Look for sort toggle buttons
- assertVisible:
    text: "Recent"
    optional: true

- assertVisible:
    text: "Popular"
    optional: true

- takeScreenshot: maestro-screenshots/comments_08_sort_toggle

# Try tapping on Popular to change sort order
- tapOn:
    text: "Popular"
    optional: true

- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/comments_09_popular_sort

# Try tapping on Recent to switch back
- tapOn:
    text: "Recent"
    optional: true

- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/comments_10_recent_sort

# Scroll to see comments list or empty state
- swipe:
    start: "50%,70%"
    end: "50%,30%"
    duration: 300

- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/comments_11_scrolled_comments

# Look for comment input area or empty state message
- assertVisible:
    text: ".*thoughts.*"
    optional: true

- assertVisible:
    text: ".*comment.*"
    optional: true

# Look for "No comments yet" empty state
- assertVisible:
    text: "No comments yet"
    optional: true

# Look for "Be the first" message
- assertVisible:
    text: ".*first.*"
    optional: true

- takeScreenshot: maestro-screenshots/comments_12_comment_input_area

# Look for "View all" comments link if there are comments
- assertVisible:
    text: ".*View all.*"
    optional: true

# Look for "Load more" comments link
- assertVisible:
    text: ".*Load more.*"
    optional: true

- takeScreenshot: maestro-screenshots/comments_13_view_all_check

# Scroll up to verify we can navigate within the sheet
- swipe:
    start: "50%,30%"
    end: "50%,70%"
    duration: 300

- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/comments_14_scrolled_up

# Dismiss the bottom sheet
- swipe:
    start: "50%,30%"
    end: "50%,95%"
    duration: 500

- waitForAnimationToEnd

# Verify we're back to the map
- extendedWaitUntil:
    visible: "Zoom.*"
    timeout: 10000

- takeScreenshot: maestro-screenshots/comments_15_back_to_map

# Verify app is still functional
- assertVisible: "Map"
- assertVisible: "Feed"

- takeScreenshot: maestro-screenshots/comments_16_final_state
