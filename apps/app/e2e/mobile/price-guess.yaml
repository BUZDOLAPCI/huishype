# Price Guess Section E2E Test
# Tests the price guess functionality within the property bottom sheet.
# Navigates to a property, expands the bottom sheet, scrolls to the Guess section,
# and verifies slider/WOZ reference/auth gate visibility.
#
# Prerequisites:
# - App installed on emulator, Metro dev server running
# - Backend API accessible with seeded data
#
# Usage:
# maestro test apps/app/e2e/mobile/price-guess.yaml

appId: nl.huishype.app
tags:
  - feature:price-guess
  - feature:bottom-sheet
---
# Launch the app
- launchApp

# Handle Expo Dev Client server picker if shown
- tapOn:
    text: ".*10.0.2.2:8081.*"
    optional: true

# Wait for app to fully load
- extendedWaitUntil:
    visible: "HuisHype"
    timeout: 60000

# Dismiss Expo developer menu if it appears
- tapOn:
    text: "Ã—"
    optional: true
- tapOn:
    point: "50%,30%"
    optional: true
- waitForAnimationToEnd

# Wait for map to render (zoom indicator confirms map is ready)
- extendedWaitUntil:
    visible: "Zoom.*"
    timeout: 20000

- takeScreenshot: maestro-screenshots/price_guess_01_map_loaded

# Zoom in to z17+ where individual property markers are visible
- tapOn:
    text: "+"
- waitForAnimationToEnd
- tapOn:
    text: "+"
- waitForAnimationToEnd
- tapOn:
    text: "+"
- waitForAnimationToEnd
- tapOn:
    text: "+"
- waitForAnimationToEnd

# One more zoom to z18 for denser markers
- tapOn:
    text: "+"
- waitForAnimationToEnd

- takeScreenshot: maestro-screenshots/price_guess_02_zoomed_to_z18

# Tap multiple screen positions to select a property
# The nearby-property fallback makes this reliable at z18
- tapOn:
    point: "50%,50%"
- waitForAnimationToEnd

- tapOn:
    point: "30%,40%"
    optional: true
- waitForAnimationToEnd

- tapOn:
    point: "70%,60%"
    optional: true
- waitForAnimationToEnd

- tapOn:
    point: "40%,30%"
    optional: true
- waitForAnimationToEnd

- tapOn:
    point: "60%,70%"
    optional: true
- waitForAnimationToEnd

- takeScreenshot: maestro-screenshots/price_guess_03_after_taps

# Verify preview card appeared with Guess button
- assertVisible:
    text: "Guess"

- takeScreenshot: maestro-screenshots/price_guess_04_preview_card_visible

# Tap Guess button on the preview card to scroll to guess section
- tapOn:
    text: "Guess"
- waitForAnimationToEnd

- takeScreenshot: maestro-screenshots/price_guess_05_after_guess_tap

# Swipe up to partially expand the bottom sheet
- swipe:
    start: "50%,90%"
    end: "50%,50%"
    duration: 500

- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/price_guess_06_partial_expand

# Swipe up again to fully expand
- swipe:
    start: "50%,50%"
    end: "50%,15%"
    duration: 500

- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/price_guess_07_full_expand

# Scroll down within the sheet to find the Price Guess section
- swipe:
    start: "50%,70%"
    end: "50%,30%"
    duration: 300

- waitForAnimationToEnd
- takeScreenshot: maestro-screenshots/price_guess_08_scrolled_to_guess

# Look for the "Guess the Price" section header
- assertVisible:
    text: ".*Guess the Price.*"
    optional: true

# Look for the description text
- assertVisible:
    text: ".*think this property is worth.*"
    optional: true

- takeScreenshot: maestro-screenshots/price_guess_09_guess_section_visible

# Scroll more to see slider and auth gate
- swipe:
    start: "50%,70%"
    end: "50%,30%"
    duration: 300

- waitForAnimationToEnd

# Look for WOZ Value reference on the slider
- assertVisible:
    text: ".*WOZ.*"
    optional: true

# Look for the Submit Guess button (should be disabled for unauthenticated user)
- assertVisible:
    text: "Submit Guess"
    optional: true

- takeScreenshot: maestro-screenshots/price_guess_10_slider_and_woz

# Verify auth gate: unauthenticated user should see sign-in prompt
- assertVisible:
    text: ".*Sign in to submit.*"
    optional: true

- assertVisible:
    text: "Sign In"
    optional: true

- takeScreenshot: maestro-screenshots/price_guess_11_auth_gate

# Scroll back up to verify navigation
- swipe:
    start: "50%,30%"
    end: "50%,70%"
    duration: 300

- waitForAnimationToEnd

# Dismiss the bottom sheet
- swipe:
    start: "50%,30%"
    end: "50%,95%"
    duration: 500

- waitForAnimationToEnd

# Verify we're back to the map
- extendedWaitUntil:
    visible: "Zoom.*"
    timeout: 10000

- takeScreenshot: maestro-screenshots/price_guess_12_back_to_map

# Verify app is still functional
- assertVisible: "Map"
- assertVisible: "Feed"

- takeScreenshot: maestro-screenshots/price_guess_13_final_state
